<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Netbones Quantstat - Stock Analyzer & Fintelligence</title>
    <link rel="stylesheet" href="styles.css?v=5">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.hcaptcha.com/1/api.js" async defer onload="onHCaptchaLoad"></script>
    <script>
        // Placeholder for hCaptcha API loaded event.
        // This ensures the function is defined even if hcaptcha.js loads before app.js
        window.onHCaptchaLoad = window.onHCaptchaLoad || function() {
            console.log('hCaptcha API loaded (placeholder)');
        };
        window.onHCaptchaSuccess = window.onHCaptchaSuccess || function(token) {
            console.log('hCaptcha success (placeholder)');
        };
        window.onHCaptchaExpired = window.onHCaptchaExpired || function() {
            console.log('hCaptcha expired (placeholder)');
        };
        window.onHCaptchaReady = window.onHCaptchaReady || function() {
            console.log('hCaptcha ready (placeholder)');
        };
    </script>
</head>

<body>
    <!-- Header will be loaded dynamically -->
    <div id="header-container"></div>

    <!-- Components will be loaded dynamically -->
    <div id="sidebar-container"></div>

    <!-- Main Content Area -->
    <div class="main-content">
        <!-- Breadcrumbs -->
        <div id="breadcrumbs-container" class="breadcrumbs">
            <a href="#" id="breadcrumb-home-link" class="breadcrumb-item breadcrumbs-home">Home</a>
            <span class="breadcrumb-separator"><i class="fas fa-chevron-right"></i></span>
            <span id="breadcrumb-tab" class="breadcrumb-item">Popular Stocks</span>
            <span id="breadcrumb-symbol-container" class="breadcrumb-separator hidden">
                <i class="fas fa-chevron-right"></i>
            </span>
            <span id="breadcrumb-symbol" class="breadcrumb-item breadcrumb-symbol hidden"></span>
        </div>

        <!-- Tab Navigation -->
        <div id="tabs-container"></div>

        <!-- Content Sections -->
        <div class="content-sections">
            <div id="dynamic-content-container">
                <!-- Dynamic content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal-container"></div>

    <!-- Scripts -->
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- AWS Amplify for authentication - using different CDN -->
    <script src="https://cdn.jsdelivr.net/npm/amazon-cognito-identity-js@6.3.6/dist/amazon-cognito-identity.min.js"></script>
    <script>
        // Expose Auth globally from amazon-cognito-identity-js
        if (typeof AmazonCognitoIdentity !== 'undefined') {
            window.Auth = {
                configure: function(config) {
                    this._config = config;
                    this._userPool = new AmazonCognitoIdentity.CognitoUserPool({
                        UserPoolId: config.userPoolId,
                        ClientId: config.userPoolWebClientId
                    });
                },
                signUp: function(params) {
                    return new Promise((resolve, reject) => {
                        const attributeList = [
                            new AmazonCognitoIdentity.CognitoUserAttribute({
                                Name: 'email',
                                Value: params.username
                            })
                        ];
                        this._userPool.signUp(params.username, params.password, attributeList, null, (err, result) => {
                            if (err) reject(err);
                            else resolve({ user: result.user });
                        });
                    });
                },
                confirmSignUp: function(username, code) {
                    return new Promise((resolve, reject) => {
                        const cognitoUser = new AmazonCognitoIdentity.CognitoUser({
                            Username: username,
                            Pool: this._userPool
                        });
                        cognitoUser.confirmRegistration(code, true, (err, result) => {
                            if (err) reject(err);
                            else resolve(result);
                        });
                    });
                },
                signIn: function(username, password) {
                    return new Promise((resolve, reject) => {
                        const authenticationDetails = new AmazonCognitoIdentity.AuthenticationDetails({
                            Username: username,
                            Password: password
                        });
                        const cognitoUser = new AmazonCognitoIdentity.CognitoUser({
                            Username: username,
                            Pool: this._userPool
                        });
                        cognitoUser.authenticateUser(authenticationDetails, {
                            onSuccess: (result) => {
                                this._currentUser = cognitoUser;
                                resolve(cognitoUser);
                            },
                            onFailure: (err) => reject(err)
                        });
                    });
                },
                signOut: function() {
                    return new Promise((resolve) => {
                        if (this._currentUser) {
                            this._currentUser.signOut();
                            this._currentUser = null;
                        }
                        resolve();
                    });
                },
                currentAuthenticatedUser: function() {
                    return new Promise((resolve, reject) => {
                        const cognitoUser = this._userPool.getCurrentUser();
                        if (!cognitoUser) {
                            reject(new Error('No current user'));
                            return;
                        }
                        cognitoUser.getSession((err, session) => {
                            if (err) reject(err);
                            else if (!session.isValid()) reject(new Error('Session invalid'));
                            else {
                                cognitoUser.getUserAttributes((err, attributes) => {
                                    if (err) reject(err);
                                    else {
                                        cognitoUser.attributes = {};
                                        attributes.forEach(attr => {
                                            cognitoUser.attributes[attr.Name] = attr.Value;
                                        });
                                        resolve(cognitoUser);
                                    }
                                });
                            }
                        });
                    });
                },
                currentSession: function() {
                    return new Promise((resolve, reject) => {
                        const cognitoUser = this._userPool.getCurrentUser();
                        if (!cognitoUser) {
                            reject(new Error('No current user'));
                            return;
                        }
                        cognitoUser.getSession((err, session) => {
                            if (err) reject(err);
                            else resolve(session);
                        });
                    });
                }
            };
            console.log('âœ“ Auth wrapper created from amazon-cognito-identity-js');
        }
    </script>

    <!-- Core modules -->
    <script src="components/loader.js?v=2"></script>
    <script src="config.js?v=3"></script>
    <script src="api.js?v=4"></script>
    <script src="auth.js?v=2"></script>
    <script src="app.js?v=4"></script>

    <!-- Utilities (must load first) -->
    <script src="utils/Formatters.js?v=2"></script>
    <script src="utils/Validators.js?v=2"></script>
    <script src="utils/EventBus.js?v=2"></script>

    <!-- DynamoDB Service (must load before UserManager) -->
    <script src="modules/dynamo-service.js?v=1"></script>

    <!-- Feature modules -->
    <!-- Feature modules -->
    <script src="modules/CircuitBreaker.js?v=2"></script>
    <script src="modules/ErrorBoundary.js?v=1"></script>
    <script src="modules/LifecycleManager.js?v=1"></script>
    <script src="modules/HealthManager.js?v=1"></script>
    <script src="modules/StockManager.js?v=3"></script>
    <script src="modules/SearchManager.js?v=2"></script>
    <script src="modules/UserManager.js?v=1"></script>
    <script src="modules/WatchlistManager.js?v=13"></script>
    <script src="modules/ChartManager.js?v=2"></script>
    <script src="modules/MetricsManager.js?v=2"></script>
    <script src="modules/FinancialsManager.js?v=1"></script>
    <script src="modules/NewsManager.js?v=1"></script>
    <script src="modules/EstimatesManager.js?v=1"></script>
    <script src="modules/FactorsManager.js?v=3"></script>
    <script src="modules/DataManager.js?v=4"></script>
    <script src="modules/UIManager.js?v=2"></script>
    <script src="modules/CalculatorManager.js?v=1"></script>
    <script src="modules/StockAnalyserManager.js?v=2"></script>
    <script src="modules/TabManager.js?v=7"></script>

    <!-- Main app (already loaded in core modules) -->
    <!-- <script src="app.js?v=4"></script> -->

    <!-- Component Loader -->
    <script>
        // Load HTML components dynamically
        async function loadComponents() {
            try {
                // Load all components in parallel
                await componentLoader.loadAll([
                    { name: 'sidebar', container: 'sidebar-container' },
                    { name: 'tabs', container: 'tabs-container' },
                    { name: 'auth-modal', container: 'auth-modal-container' }
                ]);

                // Load header (separate file in root)
                const headerResponse = await fetch('header.html');
                const headerHtml = await headerResponse.text();
                document.getElementById('header-container').innerHTML = headerHtml;

                // Load default sections - SEQUENTIALLY to ensure both load
                console.log('Loading metrics section...');
                await componentLoader.loadSection('metrics');
                console.log('Metrics section loaded');

                console.log('Loading popular-stocks section...');
                await componentLoader.loadSection('popular-stocks');
                console.log('Popular-stocks section loaded');

                console.log('All sections loaded successfully');
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Load components when DOM is ready
        document.addEventListener('DOMContentLoaded', loadComponents);
    </script>
</body>

</html>
