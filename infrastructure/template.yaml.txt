AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Stock Analyzer Application

Globals:
  Function:
    Timeout: 30
    MemorySize: 512
    Runtime: python3.12
    Environment:
      Variables:
        FACTORS_TABLE: !Ref FactorsTable
        WATCHLIST_TABLE: !Ref WatchlistTable

Parameters:
  FinancialAPIKey:
    Type: AWS::SSM::Parameter
    Properties: 
      Name: /stock-analyzer/alpha_vantage_key
      Type: String
      Value: !Ref FinancialAPIKey
      Description: Alpha Vantage API Key
  
Resources:
  # API Gateway
  StockAnalyzerAPI:
    Type: AWS::Serverless::Api
    Properties:
      StageName: prod
      Cors:
        AllowMethods: "'GET,POST,PUT,DELETE,OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"
      Auth:
        DefaultAuthorizer: NONE

  # Lambda Functions
  StockAPIFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: stock_api.lambda_handler
      Events:
        GetMetrics:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/stock/metrics
            Method: get
        GetPrice:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/stock/price
            Method: get
        GetEstimates:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/stock/estimates
            Method: get
        GetFinancials:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/stock/financials
            Method: get
        Options:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/stock/{proxy+}
            Method: options
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref FactorsTable
        - DynamoDBReadPolicy:
            TableName: !Ref WatchlistTable

  ScreenerAPIFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: screener_api.lambda_handler
      Events:
        Screen:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/screen
            Method: post
        GetFactors:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/factors
            Method: get
        SaveFactor:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/factors
            Method: post
        DCFAnalysis:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/dcf
            Method: post
        OptionsScreen:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/screen
            Method: options
        OptionsFactor:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/factors
            Method: options
        OptionsDCF:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/dcf
            Method: options
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref FactorsTable

  WatchlistAPIFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: backend/
      Handler: watchlist_api.lambda_handler
      Events:
        GetWatchlist:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/watchlist
            Method: get
        AddToWatchlist:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/watchlist
            Method: post
        UpdateWatchlist:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/watchlist
            Method: put
        DeleteFromWatchlist:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/watchlist
            Method: delete
        OptionsWatchlist:
          Type: Api
          Properties:
            RestApiId: !Ref StockAnalyzerAPI
            Path: /api/watchlist
            Method: options
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref WatchlistTable

  # DynamoDB Tables
  FactorsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: stock-factors
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: factorId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: factorId
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  WatchlistTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: stock-watchlist
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
        - AttributeName: symbol
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH
        - AttributeName: symbol
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST

  # S3 Bucket for Frontend
  FrontendBucket:
    Type: AWS::S3::Bucket
    Properties:
      
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  FrontendBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref FrontendBucket
      PolicyDocument:
        Statement:
          - Sid: PublicReadGetObject
            Effect: Allow
            Principal: '*'
            Action: 's3:GetObject'
            Resource: !Sub '${FrontendBucket.Arn}/*'

Outputs:
  APIEndpoint:
    Description: "API Gateway endpoint URL"
    Value: !Sub "https://${StockAnalyzerAPI}.execute-api.${AWS::Region}.amazonaws.com/prod/"
  
  WebsiteURL:
    Description: "S3 Website URL"
    Value: !GetAtt FrontendBucket.WebsiteURL
  
  FrontendBucketName:
    Description: "S3 Bucket for frontend"
    Value: !Ref FrontendBucket
